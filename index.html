<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCargo AI - Order Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-5xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">‚úì</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Smart Order Verification</h1>
                    <p class="text-gray-600 text-sm">Intelligent field-by-field comparison</p>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <h3 class="font-bold text-blue-900 mb-2">üß† How It Works:</h3>
            <ol class="text-sm text-blue-800 space-y-1 ml-4 list-decimal">
                <li><strong>Step 1:</strong> Extracts order number from both images (primary key)</li>
                <li><strong>Step 2:</strong> Confirms both images are for the SAME order</li>
                <li><strong>Step 3:</strong> Compares ALL fields dynamically (location, quantity, address, etc.)</li>
                <li><strong>Step 4:</strong> Reports ANY differences found between system and label</li>
            </ol>
        </div>

        <!-- Upload Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- System Screenshot -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">1Ô∏è‚É£ System Order</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition cursor-pointer" onclick="document.getElementById('systemImage').click()">
                    <div id="systemPreview" class="hidden">
                        <img id="systemImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">System screenshot uploaded ‚úì</p>
                    </div>
                    <div id="systemPlaceholder">
                        <div class="text-4xl mb-2">üñ•Ô∏è</div>
                        <p class="text-gray-600 font-semibold mb-1">System Screenshot</p>
                        <p class="text-sm text-gray-500">Order info from your system</p>
                    </div>
                </div>
                <input type="file" id="systemImage" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'system')">
                <button onclick="document.getElementById('systemImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    Choose File
                </button>
            </div>

            <!-- Physical Label Photo -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">2Ô∏è‚É£ Physical Label</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-400 transition cursor-pointer" onclick="document.getElementById('labelImage').click()">
                    <div id="labelPreview" class="hidden">
                        <img id="labelImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">Label photo uploaded ‚úì</p>
                    </div>
                    <div id="labelPlaceholder">
                        <div class="text-4xl mb-2">üì¶</div>
                        <p class="text-gray-600 font-semibold mb-1">Physical Label</p>
                        <p class="text-sm text-gray-500">Photo of the actual box label</p>
                    </div>
                </div>
                <input type="file" id="labelImage" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event, 'label')">
                <button onclick="document.getElementById('labelImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    üì∏ Take Photo / Choose File
                </button>
            </div>
        </div>

        <!-- Compare Button -->
        <div class="text-center mb-6">
            <button id="compareBtn" onclick="compareImages()" disabled class="bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed transition-all">
                Upload Both Images First
            </button>
        </div>

        <!-- Processing Status -->
        <div id="processingStatus" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-4">
                <div class="spinner"></div>
                <div class="flex-1">
                    <p class="text-blue-900 font-semibold text-lg">Processing...</p>
                    <p id="statusText" class="text-blue-700 text-sm mt-1">Reading images...</p>
                    <div class="mt-3 bg-blue-200 h-2 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Order Verification Status -->
            <div id="orderStatus" class="mb-6"></div>

            <!-- Extracted Text Preview -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-3 text-sm flex items-center gap-2">
                        <span class="text-blue-600">üñ•Ô∏è</span> System Text
                    </h3>
                    <pre id="systemData" class="bg-gray-50 p-3 rounded text-xs font-mono overflow-auto max-h-48 whitespace-pre-wrap border border-gray-200"></pre>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h3 class="font-bold text-gray-900 mb-3 text-sm flex items-center gap-2">
                        <span class="text-green-600">üì¶</span> Label Text
                    </h3>
                    <pre id="labelData" class="bg-gray-50 p-3 rounded text-xs font-mono overflow-auto max-h-48 whitespace-pre-wrap border border-gray-200"></pre>
                </div>
            </div>

            <!-- Field-by-Field Comparison -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-gray-900 mb-4 text-xl">üìä Field-by-Field Comparison</h3>
                <div id="fieldComparison"></div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4">
                <button onclick="reset()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                    üîÑ Check Another Order
                </button>
                <button onclick="downloadReport()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    üì• Download Report
                </button>
            </div>
        </div>
    </div>

    <script>
        let systemImageData = null;
        let labelImageData = null;
        let systemText = '';
        let labelText = '';
        let comparisonResults = null;

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'system') {
                    systemImageData = e.target.result;
                    document.getElementById('systemImg').src = systemImageData;
                    document.getElementById('systemPreview').classList.remove('hidden');
                    document.getElementById('systemPlaceholder').classList.add('hidden');
                } else {
                    labelImageData = e.target.result;
                    document.getElementById('labelImg').src = labelImageData;
                    document.getElementById('labelPreview').classList.remove('hidden');
                    document.getElementById('labelPlaceholder').classList.add('hidden');
                }

                if (systemImageData && labelImageData) {
                    const btn = document.getElementById('compareBtn');
                    btn.disabled = false;
                    btn.className = 'bg-blue-600 text-white px-12 py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-all shadow-lg cursor-pointer';
                    btn.textContent = 'üîç Compare Orders';
                }
            };
            reader.readAsDataURL(file);
        }

        function updateStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            if (progress !== undefined) {
                document.getElementById('progressBar').style.width = progress + '%';
            }
        }

        // Fuzzy string matching (Levenshtein distance)
        function similarity(s1, s2) {
            s1 = s1.toLowerCase().trim();
            s2 = s2.toLowerCase().trim();
            
            if (s1 === s2) return 1.0;
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        async function compareImages() {
            document.getElementById('processingStatus').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                updateStatus('Reading system screenshot...', 10);
                systemText = await extractText(systemImageData, 'system');
                document.getElementById('systemData').textContent = systemText || 'No text detected';
                updateStatus('System processed ‚úì', 50);

                updateStatus('Reading label photo...', 50);
                labelText = await extractText(labelImageData, 'label');
                document.getElementById('labelData').textContent = labelText || 'No text detected';
                updateStatus('Label processed ‚úì', 90);

                updateStatus('Analyzing and comparing...', 95);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                comparisonResults = intelligentCompare(systemText, labelText);
                displayResults(comparisonResults);
                
                updateStatus('Complete!', 100);
                setTimeout(() => {
                    document.getElementById('processingStatus').classList.add('hidden');
                    document.getElementById('results').classList.remove('hidden');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                updateStatus('Error: ' + error.message, 0);
                alert('Error processing images. Please try again.');
                document.getElementById('processingStatus').classList.add('hidden');
            }
        }

        async function extractText(imageData, source) {
            try {
                const result = await Tesseract.recognize(
                    imageData,
                    'eng+nld',
                    {
                        logger: info => {
                            if (info.status === 'recognizing text') {
                                const progress = source === 'system' 
                                    ? 10 + (info.progress * 40)
                                    : 50 + (info.progress * 40);
                                updateStatus(`Reading ${source}: ${Math.round(info.progress * 100)}%`, progress);
                            }
                        }
                    }
                );
                return result.data.text;
            } catch (error) {
                throw new Error('Failed to read ' + source + ' image');
            }
        }

        function intelligentCompare(systemText, labelText) {
            // STEP 1: Parse both texts into structured data
            const systemData = parseOrderData(systemText);
            const labelData = parseOrderData(labelText);

            // STEP 2: Find order number match (PRIMARY KEY)
            let orderMatch = null;
            let orderSimilarity = 0;

            for (const sysOrder of systemData.orderNumbers) {
                for (const lblOrder of labelData.orderNumbers) {
                    const sim = similarity(sysOrder, lblOrder);
                    if (sim > orderSimilarity) {
                        orderSimilarity = sim;
                        if (sim >= 0.75) {
                            orderMatch = {
                                system: sysOrder,
                                label: lblOrder,
                                similarity: sim
                            };
                        }
                    }
                }
            }

            // STEP 3: If orders match, compare ALL fields dynamically
            const fieldComparisons = [];

            if (orderMatch) {
                // Compare all detected fields
                const allFieldTypes = new Set([
                    ...Object.keys(systemData.fields),
                    ...Object.keys(labelData.fields)
                ]);

                allFieldTypes.forEach(fieldType => {
                    const sysValues = systemData.fields[fieldType] || [];
                    const lblValues = labelData.fields[fieldType] || [];

                    if (sysValues.length === 0 && lblValues.length === 0) return;

                    // Try to match values
                    let matched = false;
                    let bestMatch = null;
                    let bestSim = 0;

                    for (const sysVal of sysValues) {
                        for (const lblVal of lblValues) {
                            const sim = similarity(sysVal, lblVal);
                            if (sim > bestSim) {
                                bestSim = sim;
                                bestMatch = { sysVal, lblVal, sim };
                                if (sim >= 0.85) matched = true;
                            }
                        }
                    }

                    fieldComparisons.push({
                        field: fieldType,
                        systemValue: sysValues.join(', ') || 'Not found',
                        labelValue: lblValues.join(', ') || 'Not found',
                        matched: matched,
                        similarity: bestSim,
                        status: matched ? 'match' : (sysValues.length === 0 || lblValues.length === 0) ? 'missing' : 'mismatch'
                    });
                });
            }

            return {
                orderMatch,
                orderSimilarity,
                systemOrders: systemData.orderNumbers,
                labelOrders: labelData.orderNumbers,
                fieldComparisons,
                systemAllFields: systemData.fields,
                labelAllFields: labelData.fields
            };
        }

        function parseOrderData(text) {
            const data = {
                orderNumbers: [],
                fields: {}
            };

            // Extract order numbers (multiple patterns)
            const orderPatterns = [
                /(?:order|ord|#|nr|nummer)\s*:?\s*([A-Z0-9-]+)/gi,
                /\b([A-Z]{2,4}[-]?\d{3,})\b/g,
                /\b(\d{5,})\b/g
            ];

            orderPatterns.forEach(pattern => {
                const matches = [...text.matchAll(pattern)].map(m => m[1] || m[0]);
                data.orderNumbers.push(...matches);
            });
            data.orderNumbers = [...new Set(data.orderNumbers)].map(o => o.replace(/[^a-z0-9]/gi, '').toUpperCase());

            // Extract location/destination
            const locationPatterns = [
                /(?:location|loc|locatie|plaats)\s*:?\s*([^\n\r,;]{3,30})/gi,
                /(?:destination|bestemming|naar|to)\s*:?\s*([^\n\r,;]{3,30})/gi,
                /(?:city|stad|plaats)\s*:?\s*([A-Za-z\s]+)/gi
            ];
            data.fields.location = [];
            locationPatterns.forEach(pattern => {
                const matches = [...text.matchAll(pattern)].map(m => m[1].trim());
                data.fields.location.push(...matches);
            });
            data.fields.location = [...new Set(data.fields.location)];

            // Extract quantity
            const qtyPatterns = [
                /(?:qty|quantity|aantal|stuks|pcs|pieces)\s*:?\s*(\d+)/gi,
                /(\d+)\s*(?:pcs|stuks|pieces|units)/gi
            ];
            data.fields.quantity = [];
            qtyPatterns.forEach(pattern => {
                const matches = [...text.matchAll(pattern)].map(m => m[1]);
                data.fields.quantity.push(...matches);
            });
            data.fields.quantity = [...new Set(data.fields.quantity)];

            // Extract address components
            data.fields.address = [];
            const addressPattern = /(?:address|adres|straat|street)\s*:?\s*([^\n\r]{5,50})/gi;
            const matches = [...text.matchAll(addressPattern)].map(m => m[1].trim());
            data.fields.address.push(...matches);

            // Extract postal codes
            data.fields.postal = [];
            const postalPattern = /\b\d{4}\s?[A-Z]{2}\b/g;
            const postalMatches = text.match(postalPattern) || [];
            data.fields.postal.push(...postalMatches);

            // Extract dates
            data.fields.date = [];
            const datePattern = /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}\b/g;
            const dateMatches = text.match(datePattern) || [];
            data.fields.date.push(...dateMatches);

            // Extract any field with ":" pattern (dynamic)
            const genericPattern = /([A-Za-z]{3,20})\s*:\s*([^\n\r:]{2,40})/g;
            const genericMatches = [...text.matchAll(genericPattern)];
            genericMatches.forEach(match => {
                const fieldName = match[1].toLowerCase().trim();
                const fieldValue = match[2].trim();
                
                // Skip if already captured
                if (['order', 'qty', 'quantity', 'location', 'address', 'date'].includes(fieldName)) return;
                
                if (!data.fields[fieldName]) {
                    data.fields[fieldName] = [];
                }
                data.fields[fieldName].push(fieldValue);
            });

            return data;
        }

        function displayResults(results) {
            // Order Status
            const orderStatusDiv = document.getElementById('orderStatus');
            
            if (!results.orderMatch) {
                orderStatusDiv.innerHTML = `
                    <div class="border-4 bg-red-50 border-red-600 rounded-lg p-6">
                        <div class="flex items-center gap-4">
                            <div class="text-6xl">üö´</div>
                            <div class="flex-1">
                                <h4 class="text-2xl font-bold text-red-900 mb-2">WRONG ORDER!</h4>
                                <p class="text-red-700 font-semibold">System and label are for DIFFERENT orders</p>
                                <div class="grid grid-cols-2 gap-4 mt-4 text-sm bg-white p-3 rounded">
                                    <div>
                                        <span class="text-gray-600">System Orders:</span>
                                        <div class="font-mono font-bold text-red-900">${results.systemOrders.join(', ') || 'None found'}</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">Label Orders:</span>
                                        <div class="font-mono font-bold text-red-900">${results.labelOrders.join(', ') || 'None found'}</div>
                                    </div>
                                </div>
                                <p class="text-red-800 font-bold mt-3 text-lg">‚ö†Ô∏è DO NOT SHIP THIS BOX</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const allMatched = results.fieldComparisons.every(f => f.status === 'match');
                const hasMismatches = results.fieldComparisons.some(f => f.status === 'mismatch');
                
                orderStatusDiv.innerHTML = `
                    <div class="border-4 ${allMatched ? 'bg-green-50 border-green-600' : 'bg-yellow-50 border-yellow-600'} rounded-lg p-6">
                        <div class="flex items-center gap-4">
                            <div class="text-6xl">${allMatched ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                            <div class="flex-1">
                                <h4 class="text-2xl font-bold ${allMatched ? 'text-green-900' : 'text-yellow-900'} mb-2">
                                    Order Match: ${results.orderMatch.system}
                                </h4>
                                <p class="${allMatched ? 'text-green-700' : 'text-yellow-700'} font-semibold">
                                    System and label are for the SAME order (${(results.orderSimilarity * 100).toFixed(0)}% match)
                                </p>
                                ${hasMismatches ? '<p class="text-red-700 font-bold mt-2 text-lg">‚ö†Ô∏è BUT there are differences in the details - see below</p>' : '<p class="text-green-700 font-bold mt-2">All details match perfectly ‚úì</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Field Comparisons
            const fieldDiv = document.getElementById('fieldComparison');
            
            if (!results.orderMatch) {
                fieldDiv.innerHTML = `
                    <div class="bg-gray-50 border border-gray-300 rounded p-4 text-center text-gray-600">
                        Cannot compare fields - orders do not match
                    </div>
                `;
                return;
            }

            if (results.fieldComparisons.length === 0) {
                fieldDiv.innerHTML = `
                    <div class="bg-gray-50 border border-gray-300 rounded p-4 text-center text-gray-600">
                        No specific fields detected to compare. Review the extracted text above.
                    </div>
                `;
                return;
            }

            let html = '<div class="space-y-3">';
            
            results.fieldComparisons.forEach(field => {
                const bgColor = field.status === 'match' ? 'bg-green-50 border-green-400' :
                               field.status === 'mismatch' ? 'bg-red-50 border-red-400' :
                               'bg-gray-50 border-gray-400';
                
                const icon = field.status === 'match' ? '‚úÖ' :
                            field.status === 'mismatch' ? '‚ùå' :
                            '‚ö†Ô∏è';
                
                const textColor = field.status === 'match' ? 'text-green-900' :
                                 field.status === 'mismatch' ? 'text-red-900' :
                                 'text-gray-700';

                html += `
                    <div class="border-2 ${bgColor} rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${icon}</span>
                                <span class="font-bold ${textColor} text-lg capitalize">${field.field}</span>
                            </div>
                            ${field.similarity > 0 ? `<span class="text-xs px-2 py-1 bg-white rounded">${(field.similarity * 100).toFixed(0)}% similar</span>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded">
                                <p class="text-xs text-gray-600 mb-1">System:</p>
                                <p class="font-mono font-bold ${textColor}">${field.systemValue}</p>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <p class="text-xs text-gray-600 mb-1">Label:</p>
                                <p class="font-mono font-bold ${textColor}">${field.labelValue}</p>
                            </div>
                        </div>
                        ${field.status === 'mismatch' ? '<p class="text-red-700 font-semibold mt-2 text-sm">‚ö†Ô∏è MISMATCH DETECTED</p>' : ''}
                        ${field.status === 'missing' ? '<p class="text-gray-600 text-sm mt-2">Field missing in one of the sources</p>' : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            fieldDiv.innerHTML = html;
        }

        function downloadReport() {
            if (!comparisonResults) return;

            const timestamp = new Date().toLocaleString('nl-NL');
            let report = `ORDER VERIFICATION REPORT\n`;
            report += `Generated: ${timestamp}\n`;
            report += `${'='.repeat(80)}\n\n`;

            // Order Status
            report += `ORDER NUMBER VERIFICATION:\n${'-'.repeat(80)}\n`;
            if (comparisonResults.orderMatch) {
                report += `‚úì SAME ORDER\n`;
                report += `  System: ${comparisonResults.orderMatch.system}\n`;
                report += `  Label:  ${comparisonResults.orderMatch.label}\n`;
                report += `  Match:  ${(comparisonResults.orderSimilarity * 100).toFixed(1)}%\n\n`;
            } else {
                report += `‚úó DIFFERENT ORDERS - DO NOT SHIP!\n`;
                report += `  System: ${comparisonResults.systemOrders.join(', ') || 'None'}\n`;
                report += `  Label:  ${comparisonResults.labelOrders.join(', ') || 'None'}\n\n`;
            }

            // Field Comparisons
            if (comparisonResults.orderMatch && comparisonResults.fieldComparisons.length > 0) {
                report += `FIELD-BY-FIELD COMPARISON:\n${'-'.repeat(80)}\n`;
                comparisonResults.fieldComparisons.forEach(field => {
                    const status = field.status === 'match' ? '‚úì' : field.status === 'mismatch' ? '‚úó' : '‚ö†';
                    report += `${status} ${field.field.toUpperCase()}\n`;
                    report += `  System: ${field.systemValue}\n`;
                    report += `  Label:  ${field.labelValue}\n`;
                    report += `  Status: ${field.status.toUpperCase()}\n\n`;
                });
            }

            // Raw Data
            report += `\nRAW EXTRACTED TEXT:\n${'-'.repeat(80)}\n`;
            report += `SYSTEM:\n${systemText}\n\n`;
            report += `LABEL:\n${labelText}\n\n`;

            report += `${'='.repeat(80)}\n`;
            report += `FlowCargo AI - Smart Order Verification\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order-verification-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function reset() {
            systemImageData = null;
            labelImageData = null;
            systemText = '';
            labelText = '';
            comparisonResults = null;
            
            document.getElementById('systemPreview').classList.add('hidden');
            document.getElementById('systemPlaceholder').classList.remove('hidden');
            document.getElementById('labelPreview').classList.add('hidden');
            document.getElementById('labelPlaceholder').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('processingStatus').classList.add('hidden');
            document.getElementById('systemImage').value = '';
            document.getElementById('labelImage').value = '';
            document.getElementById('progressBar').style.width = '0%';
            
            const btn = document.getElementById('compareBtn');
            btn.disabled = true;
            btn.className = 'bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed';
            btn.textContent = 'Upload Both Images First';
        }
