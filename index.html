<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCargo AI - Order Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-5xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">‚úì</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Smart Order Verification</h1>
                    <p class="text-gray-600 text-sm">Intelligent label-to-system comparison</p>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">1Ô∏è‚É£ System Order</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition cursor-pointer" onclick="document.getElementById('systemImage').click()">
                    <div id="systemPreview" class="hidden">
                        <img id="systemImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">Screenshot uploaded ‚úì</p>
                    </div>
                    <div id="systemPlaceholder">
                        <div class="text-4xl mb-2">üñ•Ô∏è</div>
                        <p class="text-gray-600 font-semibold mb-1">System Screenshot</p>
                        <p class="text-sm text-gray-500">Order from your system</p>
                    </div>
                </div>
                <input type="file" id="systemImage" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'system')">
                <button onclick="document.getElementById('systemImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    Choose File
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">2Ô∏è‚É£ Physical Label</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-400 transition cursor-pointer" onclick="document.getElementById('labelImage').click()">
                    <div id="labelPreview" class="hidden">
                        <img id="labelImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">Label photo uploaded ‚úì</p>
                    </div>
                    <div id="labelPlaceholder">
                        <div class="text-4xl mb-2">üì¶</div>
                        <p class="text-gray-600 font-semibold mb-1">Physical Label</p>
                        <p class="text-sm text-gray-500">Photo of the box label</p>
                    </div>
                </div>
                <input type="file" id="labelImage" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event, 'label')">
                <button onclick="document.getElementById('labelImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    üì∏ Take Photo
                </button>
            </div>
        </div>

        <div class="text-center mb-6">
            <button id="compareBtn" onclick="compareImages()" disabled class="bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed transition-all">
                Upload Both Images First
            </button>
        </div>

        <!-- Processing -->
        <div id="processingStatus" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-4">
                <div class="spinner"></div>
                <div class="flex-1">
                    <p class="text-blue-900 font-semibold text-lg">Processing...</p>
                    <p id="statusText" class="text-blue-700 text-sm mt-1">Reading images...</p>
                    <div class="mt-3 bg-blue-200 h-2 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden">
            <!-- Main Verdict -->
            <div id="verdict" class="mb-6"></div>

            <!-- Details (collapsible) -->
            <div id="detailsSection" class="hidden">
                <button onclick="toggleDetails()" class="w-full bg-white rounded-lg shadow p-4 mb-6 text-left hover:bg-gray-50 transition">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-gray-900">üìã View Detailed Comparison</span>
                        <span id="detailsToggle">‚ñº</span>
                    </div>
                </button>
                
                <div id="detailsContent" class="hidden space-y-4 mb-6">
                    <!-- Field comparisons -->
                    <div id="fieldDetails" class="bg-white rounded-lg shadow-lg p-6"></div>
                    
                    <!-- Raw text -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="font-bold text-gray-900 mb-4">Raw Extracted Text</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-xs text-gray-600 mb-2 font-semibold">System:</p>
                                <pre id="systemData" class="bg-gray-50 p-3 rounded text-xs font-mono overflow-auto max-h-48 whitespace-pre-wrap border"></pre>
                            </div>
                            <div>
                                <p class="text-xs text-gray-600 mb-2 font-semibold">Label:</p>
                                <pre id="labelData" class="bg-gray-50 p-3 rounded text-xs font-mono overflow-auto max-h-48 whitespace-pre-wrap border"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4">
                <button onclick="reset()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                    üîÑ Check Another Order
                </button>
                <button onclick="downloadReport()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    üì• Download Report
                </button>
            </div>
        </div>
    </div>

    <script>
        let systemImageData = null;
        let labelImageData = null;
        let systemText = '';
        let labelText = '';
        let comparisonResults = null;
        let detailsVisible = false;

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'system') {
                    systemImageData = e.target.result;
                    document.getElementById('systemImg').src = systemImageData;
                    document.getElementById('systemPreview').classList.remove('hidden');
                    document.getElementById('systemPlaceholder').classList.add('hidden');
                } else {
                    labelImageData = e.target.result;
                    document.getElementById('labelImg').src = labelImageData;
                    document.getElementById('labelPreview').classList.remove('hidden');
                    document.getElementById('labelPlaceholder').classList.add('hidden');
                }

                if (systemImageData && labelImageData) {
                    const btn = document.getElementById('compareBtn');
                    btn.disabled = false;
                    btn.className = 'bg-blue-600 text-white px-12 py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-all shadow-lg cursor-pointer';
                    btn.textContent = 'üîç Compare Orders';
                }
            };
            reader.readAsDataURL(file);
        }

        function updateStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            if (progress !== undefined) {
                document.getElementById('progressBar').style.width = progress + '%';
            }
        }

        function toggleDetails() {
            detailsVisible = !detailsVisible;
            const content = document.getElementById('detailsContent');
            const toggle = document.getElementById('detailsToggle');
            
            if (detailsVisible) {
                content.classList.remove('hidden');
                toggle.textContent = '‚ñ≤';
            } else {
                content.classList.add('hidden');
                toggle.textContent = '‚ñº';
            }
        }

        function similarity(s1, s2) {
            if (!s1 || !s2) return 0;
            s1 = s1.toLowerCase().replace(/[^a-z0-9]/g, '');
            s2 = s2.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (s1 === s2) return 1.0;
            
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            let matches = 0;
            for (let i = 0; i < shorter.length; i++) {
                if (longer.includes(shorter[i])) matches++;
            }
            
            return matches / longer.length;
        }

        async function compareImages() {
            document.getElementById('processingStatus').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                updateStatus('Reading system screenshot...', 10);
                systemText = await extractText(systemImageData, 'system');
                document.getElementById('systemData').textContent = systemText || 'No text detected';
                updateStatus('System processed ‚úì', 50);

                updateStatus('Reading label photo...', 50);
                labelText = await extractText(labelImageData, 'label');
                document.getElementById('labelData').textContent = labelText || 'No text detected';
                updateStatus('Label processed ‚úì', 90);

                updateStatus('Comparing...', 95);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                comparisonResults = smartCompare(systemText, labelText);
                displayResults(comparisonResults);
                
                updateStatus('Complete!', 100);
                setTimeout(() => {
                    document.getElementById('processingStatus').classList.add('hidden');
                    document.getElementById('results').classList.remove('hidden');
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                alert('Error processing images. Please try again with clearer photos.');
                document.getElementById('processingStatus').classList.add('hidden');
            }
        }

        async function extractText(imageData, source) {
            try {
                const result = await Tesseract.recognize(
                    imageData,
                    'eng+nld',
                    {
                        logger: info => {
                            if (info.status === 'recognizing text') {
                                const progress = source === 'system' 
                                    ? 10 + (info.progress * 40)
                                    : 50 + (info.progress * 40);
                                updateStatus(`Reading ${source}: ${Math.round(info.progress * 100)}%`, progress);
                            }
                        }
                    }
                );
                return result.data.text;
            } catch (error) {
                throw new Error('Failed to read ' + source);
            }
        }

        function smartCompare(systemText, labelText) {
            const systemData = parseStructured(systemText);
            const labelData = parseStructured(labelText);

            // Find order number match
            let orderMatch = null;
            let orderSim = 0;

            if (systemData.orderNumber && labelData.orderNumber) {
                orderSim = similarity(systemData.orderNumber, labelData.orderNumber);
                if (orderSim >= 0.75) {
                    orderMatch = {
                        system: systemData.orderNumber,
                        label: labelData.orderNumber,
                        similarity: orderSim
                    };
                }
            }

            // Compare fields if order matches
            const fieldResults = [];
            
            if (orderMatch) {
                // Location
                if (systemData.location || labelData.location) {
                    const locSim = similarity(systemData.location, labelData.location);
                    fieldResults.push({
                        name: 'Location',
                        system: systemData.location || 'Not found',
                        label: labelData.location || 'Not found',
                        match: locSim >= 0.85,
                        similarity: locSim
                    });
                }

                // Quantity
                if (systemData.quantity || labelData.quantity) {
                    const match = systemData.quantity === labelData.quantity;
                    fieldResults.push({
                        name: 'Quantity',
                        system: systemData.quantity || 'Not found',
                        label: labelData.quantity || 'Not found',
                        match: match,
                        similarity: match ? 1.0 : 0
                    });
                }

                // Address
                if (systemData.address || labelData.address) {
                    const addrSim = similarity(systemData.address, labelData.address);
                    fieldResults.push({
                        name: 'Address',
                        system: systemData.address || 'Not found',
                        label: labelData.address || 'Not found',
                        match: addrSim >= 0.80,
                        similarity: addrSim
                    });
                }

                // Postal
                if (systemData.postal || labelData.postal) {
                    const match = systemData.postal === labelData.postal;
                    fieldResults.push({
                        name: 'Postal Code',
                        system: systemData.postal || 'Not found',
                        label: labelData.postal || 'Not found',
                        match: match,
                        similarity: match ? 1.0 : 0
                    });
                }
            }

            return {
                orderMatch,
                orderSim,
                fieldResults,
                systemData,
                labelData
            };
        }

        function parseStructured(text) {
            const data = {};
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);

            // Find order number - look for label then value
            for (let i = 0; i < lines.length - 1; i++) {
                const line = lines[i].toLowerCase();
                if (line.match(/^(order|ord|nummer|#|nr)[\s:]*$/)) {
                    // Next line is the value
                    data.orderNumber = lines[i + 1].replace(/[^a-z0-9-]/gi, '').toUpperCase();
                    break;
                }
            }
            
            // Also try inline pattern
            if (!data.orderNumber) {
                const match = text.match(/(?:order|ord|#|nr|nummer)\s*[:=]?\s*([A-Z0-9-]+)/i);
                if (match) {
                    data.orderNumber = match[1].replace(/[^a-z0-9-]/gi, '').toUpperCase();
                }
            }

            // Find location - same pattern
            for (let i = 0; i < lines.length - 1; i++) {
                const line = lines[i].toLowerCase();
                if (line.match(/^(location|locatie|destination|plaats)[\s:]*$/)) {
                    data.location = lines[i + 1];
                    break;
                }
            }
            if (!data.location) {
                const match = text.match(/(?:location|locatie|destination|plaats)\s*[:=]?\s*([^\n]{3,30})/i);
                if (match) data.location = match[1].trim();
            }

            // Find quantity
            for (let i = 0; i < lines.length - 1; i++) {
                const line = lines[i].toLowerCase();
                if (line.match(/^(qty|quantity|aantal)[\s:]*$/)) {
                    const nextLine = lines[i + 1];
                    const num = nextLine.match(/\d+/);
                    if (num) data.quantity = num[0];
                    break;
                }
            }
            if (!data.quantity) {
                const match = text.match(/(?:qty|quantity|aantal)\s*[:=]?\s*(\d+)/i);
                if (match) data.quantity = match[1];
            }

            // Find address
            for (let i = 0; i < lines.length - 1; i++) {
                const line = lines[i].toLowerCase();
                if (line.match(/^(address|adres|straat)[\s:]*$/)) {
                    data.address = lines[i + 1];
                    break;
                }
            }
            if (!data.address) {
                const match = text.match(/(?:address|adres|straat)\s*[:=]?\s*([^\n]{5,50})/i);
                if (match) data.address = match[1].trim();
            }

            // Find postal code
            const postalMatch = text.match(/\b(\d{4}\s?[A-Z]{2})\b/);
            if (postalMatch) data.postal = postalMatch[1];

            return data;
        }

        function displayResults(results) {
            const verdictDiv = document.getElementById('verdict');
            
            // Case 1: Order numbers don't match
            if (!results.orderMatch) {
                verdictDiv.innerHTML = `
                    <div class="bg-red-50 border-4 border-red-600 rounded-xl p-8">
                        <div class="text-center mb-6">
                            <div class="text-8xl mb-4">üö´</div>
                            <h2 class="text-3xl font-bold text-red-900 mb-3">WRONG ORDER!</h2>
                            <p class="text-xl text-red-700 font-semibold">Order number mismatch</p>
                        </div>
                        <div class="bg-white rounded-lg p-6 grid md:grid-cols-2 gap-6">
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">System Order:</p>
                                <p class="text-2xl font-mono font-bold text-gray-900">${results.systemData.orderNumber || 'Not found'}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">Label Order:</p>
                                <p class="text-2xl font-mono font-bold text-gray-900">${results.labelData.orderNumber || 'Not found'}</p>
                            </div>
                        </div>
                        <div class="mt-6 bg-red-100 border-2 border-red-700 rounded-lg p-4 text-center">
                            <p class="text-red-900 font-bold text-xl">‚ö†Ô∏è DO NOT SHIP THIS BOX</p>
                        </div>
                    </div>
                `;
                document.getElementById('detailsSection').classList.add('hidden');
                return;
            }

            // Case 2: Order matches - check fields
            const mismatches = results.fieldResults.filter(f => !f.match);
            const allGood = mismatches.length === 0;

            if (allGood) {
                // All perfect
                verdictDiv.innerHTML = `
                    <div class="bg-green-50 border-4 border-green-600 rounded-xl p-8">
                        <div class="text-center mb-6">
                            <div class="text-8xl mb-4">‚úÖ</div>
                            <h2 class="text-3xl font-bold text-green-900 mb-3">ORDER VERIFIED!</h2>
                            <p class="text-xl text-green-700">Order: <span class="font-mono font-bold">${results.orderMatch.system}</span></p>
                        </div>
                        <div class="bg-white rounded-lg p-6">
                            <p class="text-center text-green-800 font-semibold text-lg">All details match perfectly</p>
                            <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-center text-sm">
                                ${results.fieldResults.map(f => `
                                    <div class="bg-green-50 rounded p-2">
                                        <span class="text-green-700">‚úì ${f.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="mt-6 bg-green-100 border-2 border-green-700 rounded-lg p-4 text-center">
                            <p class="text-green-900 font-bold text-xl">‚úì SAFE TO SHIP</p>
                        </div>
                    </div>
                `;
            } else {
                // Has mismatches
                const mismatchNames = mismatches.map(m => m.name).join(', ');
                verdictDiv.innerHTML = `
                    <div class="bg-yellow-50 border-4 border-yellow-600 rounded-xl p-8">
                        <div class="text-center mb-6">
                            <div class="text-8xl mb-4">‚ö†Ô∏è</div>
                            <h2 class="text-3xl font-bold text-yellow-900 mb-3">MISMATCHES FOUND</h2>
                            <p class="text-xl text-yellow-700">Order: <span class="font-mono font-bold">${results.orderMatch.system}</span> ‚úì</p>
                            <p class="text-lg text-yellow-800 mt-2">But details don't match</p>
                        </div>
                        <div class="bg-white rounded-lg p-6">
                            <p class="text-red-700 font-bold text-lg mb-4">‚ùå Mismatches:</p>
                            ${mismatches.map(m => `
                                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-3">
                                    <p class="font-bold text-red-900 mb-2">${m.name} mismatch</p>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span class="text-gray-600">System:</span>
                                            <span class="font-mono font-bold ml-2">${m.system}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Label:</span>
                                            <span class="font-mono font-bold ml-2">${m.label}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-6 bg-yellow-100 border-2 border-yellow-700 rounded-lg p-4 text-center">
                            <p class="text-yellow-900 font-bold text-xl">‚ö†Ô∏è VERIFY BEFORE SHIPPING</p>
                        </div>
                    </div>
                `;
            }

            // Show details section
            document.getElementById('detailsSection').classList.remove('hidden');
            
            // Fill field details
            let fieldHtml = '<div class="space-y-3">';
            results.fieldResults.forEach(field => {
                const color = field.match ? 'green' : 'red';
                const icon = field.match ? '‚úÖ' : '‚ùå';
                fieldHtml += `
                    <div class="border-2 border-${color}-300 bg-${color}-50 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">${icon}</span>
                            <span class="font-bold text-${color}-900">${field.name}</span>
                            <span class="text-xs bg-white px-2 py-1 rounded ml-auto">${Math.round(field.similarity * 100)}%</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-white p-2 rounded">
                                <p class="text-xs text-gray-600">System:</p>
                                <p class="font-mono font-bold">${field.system}</p>
                            </div>
                            <div class="bg-white p-2 rounded">
                                <p class="text-xs text-gray-600">Label:</p>
                                <p class="font-mono font-bold">${field.label}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            fieldHtml += '</div>';
            document.getElementById('fieldDetails').innerHTML = fieldHtml;
        }

        function downloadReport() {
            if (!comparisonResults) return;

            let report = `ORDER VERIFICATION REPORT\n`;
            report += `${('=').repeat(60)}\n\n`;

            if (!comparisonResults.orderMatch) {
                report += `STATUS: FAILED - WRONG ORDER\n\n`;
                report += `Order number mismatch\n`;
                report += `System: ${comparisonResults.systemData.orderNumber || 'Not found'}\n`;
                report += `Label:  ${comparisonResults.labelData.orderNumber || 'Not found'}\n\n`;
                report += `ACTION: DO NOT SHIP\n`;
            } else {
                const mismatches = comparisonResults.fieldResults.filter(f => !f.match);
                
                if (mismatches.length === 0) {
                    report += `STATUS: PASSED\n\n`;
                    report += `Order: ${comparisonResults.orderMatch.system}\n`;
                    report += `All fields verified ‚úì\n\n`;
                    report += `ACTION: SAFE TO SHIP\n`;
                } else {
                    report += `STATUS: WARNING - MISMATCHES FOUND\n\n`;
                    report += `Order: ${comparisonResults.orderMatch.system} ‚úì\n\n`;
                    report += `MISMATCHES:\n`;
                    mismatches.forEach(m => {
                        report += `- ${m.name}\n`;
                        report += `  System: ${m.system}\n`;
                        report += `  Label:  ${m.label}\n\n`;
                    });
                    report += `ACTION: VERIFY BEFORE SHIPPING\n`;
                }
            }

            report += `\n${('=').repeat(60)}\n`;
            report += `Generated: ${new Date().toLocaleString()}\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `verification-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function reset() {
            systemImageData = null;
            labelImageData = null;
            systemText = '';
            labelText = '';
            comparisonResults = null;
            detailsVisible = false;
            
            document.getElementById('systemPreview').classList.add('hidden');
            document.getElementById('systemPlaceholder').classList.remove('hidden');
            document.getElementById('labelPreview').classList.add('hidden');
            document.getElementById('labelPlaceholder').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('detailsContent').classList.add('hidden');
            document.getElementById('processingStatus').classList.add('hidden');
            document.getElementById('systemImage').value = '';
            document.getElementById('labelImage').value = '';
            document.getElementById('progressBar').style.width = '0%';
            
            const btn = document.getElementById('compareBtn');
            btn.disabled = true;
            btn.className = 'bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed';
            btn.textContent = 'Upload Both Images First';
        }
    </script>
</body>
</html>
