<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCargo AI - Order Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .comparison-match {
            background: #ecfdf5;
            border: 2px solid #10b981;
        }
        .comparison-mismatch {
            background: #fef2f2;
            border: 2px solid #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">‚úì</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Order Verification Tool</h1>
                    <p class="text-gray-600 text-sm">Real OCR - Compare system orders with physical labels</p>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <h3 class="font-bold text-blue-900 mb-2">üìã How to use:</h3>
            <ol class="text-sm text-blue-800 space-y-1 ml-4 list-decimal">
                <li>Upload a screenshot of the order from your system</li>
                <li>Upload a photo of the physical box label</li>
                <li>Click "Compare" and AI will extract and compare the text</li>
                <li>Review matches and mismatches</li>
            </ol>
        </div>

        <!-- Upload Section -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- System Screenshot -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">1Ô∏è‚É£ System Screenshot</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition cursor-pointer" onclick="document.getElementById('systemImage').click()">
                    <div id="systemPreview" class="hidden">
                        <img id="systemImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">Screenshot uploaded ‚úì</p>
                    </div>
                    <div id="systemPlaceholder">
                        <div class="text-4xl mb-2">üñ•Ô∏è</div>
                        <p class="text-gray-600 font-semibold mb-1">Upload System Screenshot</p>
                        <p class="text-sm text-gray-500">Order details from your legacy system</p>
                    </div>
                </div>
                <input type="file" id="systemImage" accept="image/*" class="hidden" onchange="handleImageUpload(event, 'system')">
                <button onclick="document.getElementById('systemImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    Choose File
                </button>
            </div>

            <!-- Physical Label Photo -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">2Ô∏è‚É£ Physical Label Photo</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-400 transition cursor-pointer" onclick="document.getElementById('labelImage').click()">
                    <div id="labelPreview" class="hidden">
                        <img id="labelImg" class="max-h-64 mx-auto rounded mb-4 object-contain">
                        <p class="text-sm text-gray-600 mb-2">Label photo uploaded ‚úì</p>
                    </div>
                    <div id="labelPlaceholder">
                        <div class="text-4xl mb-2">üì¶</div>
                        <p class="text-gray-600 font-semibold mb-1">Upload Box Label Photo</p>
                        <p class="text-sm text-gray-500">Photo of the physical package label</p>
                    </div>
                </div>
                <input type="file" id="labelImage" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event, 'label')">
                <button onclick="document.getElementById('labelImage').click()" class="mt-4 w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    üì∏ Take Photo / Choose File
                </button>
            </div>
        </div>

        <!-- Compare Button -->
        <div class="text-center mb-6">
            <button id="compareBtn" onclick="compareImages()" disabled class="bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed transition-all">
                Upload Both Images First
            </button>
        </div>

        <!-- Processing Status -->
        <div id="processingStatus" class="hidden bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center gap-4">
                <div class="spinner"></div>
                <div class="flex-1">
                    <p class="text-blue-900 font-semibold text-lg">Processing images...</p>
                    <p id="statusText" class="text-blue-700 text-sm mt-1">Initializing OCR engine...</p>
                    <div class="mt-3 bg-blue-200 h-2 rounded-full overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Overall Status -->
            <div id="overallStatus" class="mb-6"></div>

            <!-- Extracted Data -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="text-blue-600">üñ•Ô∏è</span> System Data Extracted
                    </h3>
                    <pre id="systemData" class="bg-gray-50 p-4 rounded text-xs font-mono overflow-auto max-h-64 whitespace-pre-wrap border border-gray-200"></pre>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <span class="text-green-600">üì¶</span> Label Data Extracted
                    </h3>
                    <pre id="labelData" class="bg-gray-50 p-4 rounded text-xs font-mono overflow-auto max-h-64 whitespace-pre-wrap border border-gray-200"></pre>
                </div>
            </div>

            <!-- Comparison Results -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-gray-900 mb-4 text-xl">üîç Comparison Analysis</h3>
                
                <!-- Match Percentage -->
                <div id="matchPercentage" class="mb-6"></div>

                <!-- Detected Fields -->
                <div id="detectedFields"></div>

                <!-- Text Similarity -->
                <div id="textSimilarity" class="mt-6"></div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4">
                <button onclick="reset()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                    üîÑ Check Another Order
                </button>
                <button onclick="downloadReport()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                    üì• Download Report
                </button>
                <button onclick="copyToClipboard()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                    üìã Copy Results
                </button>
            </div>
        </div>
    </div>

    <script>
        let systemImageData = null;
        let labelImageData = null;
        let systemText = '';
        let labelText = '';
        let comparisonResults = null;

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'system') {
                    systemImageData = e.target.result;
                    document.getElementById('systemImg').src = systemImageData;
                    document.getElementById('systemPreview').classList.remove('hidden');
                    document.getElementById('systemPlaceholder').classList.add('hidden');
                } else {
                    labelImageData = e.target.result;
                    document.getElementById('labelImg').src = labelImageData;
                    document.getElementById('labelPreview').classList.remove('hidden');
                    document.getElementById('labelPlaceholder').classList.add('hidden');
                }

                if (systemImageData && labelImageData) {
                    const btn = document.getElementById('compareBtn');
                    btn.disabled = false;
                    btn.className = 'bg-blue-600 text-white px-12 py-4 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-all shadow-lg cursor-pointer';
                    btn.textContent = 'üîç Compare Images with OCR';
                }
            };
            reader.readAsDataURL(file);
        }

        function updateStatus(message, progress) {
            document.getElementById('statusText').textContent = message;
            if (progress !== undefined) {
                document.getElementById('progressBar').style.width = progress + '%';
            }
        }

        async function compareImages() {
            document.getElementById('processingStatus').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                // Extract text from system screenshot
                updateStatus('Reading system screenshot with OCR...', 10);
                systemText = await extractText(systemImageData, 'system');
                document.getElementById('systemData').textContent = systemText || 'No text detected';
                updateStatus('System screenshot processed ‚úì', 50);

                // Extract text from label photo
                updateStatus('Reading label photo with OCR...', 50);
                labelText = await extractText(labelImageData, 'label');
                document.getElementById('labelData').textContent = labelText || 'No text detected';
                updateStatus('Label photo processed ‚úì', 90);

                // Compare the texts
                updateStatus('Analyzing and comparing data...', 95);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                comparisonResults = compareTexts(systemText, labelText);
                displayResults(comparisonResults);
                
                updateStatus('Complete!', 100);
                setTimeout(() => {
                    document.getElementById('processingStatus').classList.add('hidden');
                    document.getElementById('results').classList.remove('hidden');
                }, 500);

            } catch (error) {
                console.error('Error during comparison:', error);
                updateStatus('Error: ' + error.message, 0);
                alert('Error processing images. Please try again with clearer photos.');
                document.getElementById('processingStatus').classList.add('hidden');
            }
        }

        async function extractText(imageData, source) {
            try {
                const result = await Tesseract.recognize(
                    imageData,
                    'eng+nld',
                    {
                        logger: info => {
                            if (info.status === 'recognizing text') {
                                const progress = source === 'system' 
                                    ? 10 + (info.progress * 40)
                                    : 50 + (info.progress * 40);
                                updateStatus(`Reading ${source} image: ${Math.round(info.progress * 100)}%`, progress);
                            }
                        }
                    }
                );
                return result.data.text;
            } catch (error) {
                console.error('OCR Error:', error);
                throw new Error('Failed to read text from ' + source + ' image');
            }
        }

        function compareTexts(system, label) {
            // Extract key information using regex patterns
            const patterns = {
                orderNumber: /(?:order|ord|#|nr|nummer)\s*:?\s*([A-Z0-9-]+)/gi,
                quantity: /(?:qty|quantity|aantal|stuks)\s*:?\s*(\d+)/gi,
                date: /\b\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}\b/g,
                postal: /\b\d{4}\s?[A-Z]{2}\b/g,
                numbers: /\b\d{3,}\b/g
            };

            const systemData = extractPatterns(system, patterns);
            const labelData = extractPatterns(label, patterns);

            const matches = [];
            const mismatches = [];

            // Compare order numbers
            if (systemData.orderNumber.length > 0 || labelData.orderNumber.length > 0) {
                const commonOrders = systemData.orderNumber.filter(o => 
                    labelData.orderNumber.some(l => l.toLowerCase() === o.toLowerCase())
                );
                
                if (commonOrders.length > 0) {
                    matches.push({
                        field: 'Order Number',
                        value: commonOrders[0],
                        confidence: 'high'
                    });
                } else {
                    mismatches.push({
                        field: 'Order Number',
                        system: systemData.orderNumber.join(', ') || 'Not found',
                        label: labelData.orderNumber.join(', ') || 'Not found',
                        severity: 'high'
                    });
                }
            }

            // Compare quantities
            if (systemData.quantity.length > 0 && labelData.quantity.length > 0) {
                const sysQty = systemData.quantity[0];
                const lblQty = labelData.quantity[0];
                
                if (sysQty === lblQty) {
                    matches.push({
                        field: 'Quantity',
                        value: sysQty,
                        confidence: 'high'
                    });
                } else {
                    mismatches.push({
                        field: 'Quantity',
                        system: sysQty,
                        label: lblQty,
                        severity: 'high'
                    });
                }
            }

            // Compare dates
            if (systemData.date.length > 0 && labelData.date.length > 0) {
                const commonDates = systemData.date.filter(d => labelData.date.includes(d));
                if (commonDates.length > 0) {
                    matches.push({
                        field: 'Date',
                        value: commonDates[0],
                        confidence: 'medium'
                    });
                }
            }

            // Compare postal codes
            if (systemData.postal.length > 0 && labelData.postal.length > 0) {
                const commonPostal = systemData.postal.filter(p => labelData.postal.includes(p));
                if (commonPostal.length > 0) {
                    matches.push({
                        field: 'Postal Code',
                        value: commonPostal[0],
                        confidence: 'medium'
                    });
                }
            }

            // Calculate text similarity
            const systemWords = new Set(system.toLowerCase().match(/\b[a-z0-9]{3,}\b/g) || []);
            const labelWords = new Set(label.toLowerCase().match(/\b[a-z0-9]{3,}\b/g) || []);
            const commonWords = [...systemWords].filter(w => labelWords.has(w));
            const matchPercentage = systemWords.size > 0 
                ? Math.round((commonWords.length / Math.max(systemWords.size, labelWords.size)) * 100)
                : 0;

            return {
                matches,
                mismatches,
                matchPercentage,
                commonWords,
                systemData,
                labelData
            };
        }

        function extractPatterns(text, patterns) {
            const result = {};
            for (const [key, pattern] of Object.entries(patterns)) {
                const matches = [...text.matchAll(pattern)].map(m => m[1] || m[0]);
                result[key] = [...new Set(matches)]; // Remove duplicates
            }
            return result;
        }

        function displayResults(results) {
            // Overall status
            const overallDiv = document.getElementById('overallStatus');
            const hasIssues = results.mismatches.length > 0;
            
            overallDiv.innerHTML = `
                <div class="border-2 rounded-lg p-6 ${hasIssues ? 'bg-yellow-50 border-yellow-500' : 'bg-green-50 border-green-500'}">
                    <div class="flex items-center gap-4">
                        <div class="text-5xl">${hasIssues ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                        <div>
                            <h4 class="text-xl font-bold ${hasIssues ? 'text-yellow-900' : 'text-green-900'}">
                                ${hasIssues ? 'Review Required' : 'Order Verified!'}
                            </h4>
                            <p class="${hasIssues ? 'text-yellow-700' : 'text-green-700'}">
                                ${results.matches.length} matches, ${results.mismatches.length} issues found
                            </p>
                        </div>
                    </div>
                </div>
            `;

            // Match percentage
            const matchDiv = document.getElementById('matchPercentage');
            const color = results.matchPercentage >= 70 ? 'green' : results.matchPercentage >= 40 ? 'yellow' : 'red';
            matchDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold text-gray-700">Text Similarity</span>
                    <span class="text-sm font-bold text-${color}-600">${results.matchPercentage}%</span>
                </div>
                <div class="bg-gray-200 h-4 rounded-full overflow-hidden">
                    <div class="h-full bg-${color}-500 transition-all" style="width: ${results.matchPercentage}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">${results.commonWords.length} common words found</p>
            `;

            // Detected fields
            let fieldsHtml = '';
            
            if (results.mismatches.length > 0) {
                fieldsHtml += '<div class="mb-4"><h4 class="font-bold text-red-900 mb-3">‚ùå Mismatches:</h4>';
                results.mismatches.forEach(mismatch => {
                    fieldsHtml += `
                        <div class="comparison-mismatch rounded-lg p-4 mb-3">
                            <p class="font-semibold text-gray-900 mb-2">${mismatch.field}</p>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">System:</span>
                                    <span class="font-mono font-bold ml-2 text-red-900">${mismatch.system}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Label:</span>
                                    <span class="font-mono font-bold ml-2 text-red-900">${mismatch.label}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                fieldsHtml += '</div>';
            }

            if (results.matches.length > 0) {
                fieldsHtml += '<div><h4 class="font-bold text-green-900 mb-3">‚úì Verified Matches:</h4>';
                results.matches.forEach(match => {
                    fieldsHtml += `
                        <div class="comparison-match rounded-lg p-3 mb-2 flex justify-between items-center">
                            <div>
                                <span class="text-gray-700 font-semibold">${match.field}:</span>
                                <span class="font-mono font-bold ml-2 text-green-900">${match.value}</span>
                            </div>
                            <span class="text-xs px-2 py-1 bg-green-200 text-green-800 rounded">${match.confidence} confidence</span>
                        </div>
                    `;
                });
                fieldsHtml += '</div>';
            }

            if (results.matches.length === 0 && results.mismatches.length === 0) {
                fieldsHtml = `
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-6 text-center">
                        <p class="text-gray-600">No specific fields detected. Check the extracted text above to verify manually.</p>
                    </div>
                `;
            }

            document.getElementById('detectedFields').innerHTML = fieldsHtml;
        }

        function downloadReport() {
            if (!comparisonResults) return;

            const timestamp = new Date().toLocaleString('nl-NL');
            let report = `ORDER VERIFICATION REPORT\n`;
            report += `Generated: ${timestamp}\n`;
            report += `${'='.repeat(60)}\n\n`;

            report += `VERIFICATION STATUS: ${comparisonResults.mismatches.length === 0 ? 'PASSED ‚úì' : 'FAILED ‚úó'}\n`;
            report += `Match Percentage: ${comparisonResults.matchPercentage}%\n\n`;

            report += `SYSTEM DATA:\n${'-'.repeat(60)}\n${systemText}\n\n`;
            report += `LABEL DATA:\n${'-'.repeat(60)}\n${labelText}\n\n`;

            if (comparisonResults.matches.length > 0) {
                report += `VERIFIED MATCHES:\n${'-'.repeat(60)}\n`;
                comparisonResults.matches.forEach(m => {
                    report += `‚úì ${m.field}: ${m.value}\n`;
                });
                report += '\n';
            }

            if (comparisonResults.mismatches.length > 0) {
                report += `MISMATCHES FOUND:\n${'-'.repeat(60)}\n`;
                comparisonResults.mismatches.forEach(m => {
                    report += `‚úó ${m.field}\n`;
                    report += `  System: ${m.system}\n`;
                    report += `  Label:  ${m.label}\n\n`;
                });
            }

            report += `\n${'='.repeat(60)}\n`;
            report += `Report generated by FlowCargo AI Order Verification Tool\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `order-verification-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if (!comparisonResults) return;

            let text = `Verification: ${comparisonResults.mismatches.length === 0 ? 'PASSED' : 'FAILED'}\n`;
            text += `Matches: ${comparisonResults.matches.length}, Issues: ${comparisonResults.mismatches.length}\n\n`;
            
            if (comparisonResults.mismatches.length > 0) {
                text += 'ISSUES:\n';
                comparisonResults.mismatches.forEach(m => {
                    text += `- ${m.field}: System="${m.system}" vs Label="${m.label}"\n`;
                });
            }

            navigator.clipboard.writeText(text).then(() => {
                alert('Results copied to clipboard!');
            });
        }

        function reset() {
            systemImageData = null;
            labelImageData = null;
            systemText = '';
            labelText = '';
            comparisonResults = null;
            
            document.getElementById('systemPreview').classList.add('hidden');
            document.getElementById('systemPlaceholder').classList.remove('hidden');
            document.getElementById('labelPreview').classList.add('hidden');
            document.getElementById('labelPlaceholder').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('processingStatus').classList.add('hidden');
            document.getElementById('systemImage').value = '';
            document.getElementById('labelImage').value = '';
            document.getElementById('progressBar').style.width = '0%';
            
            const btn = document.getElementById('compareBtn');
            btn.disabled = true;
            btn.className = 'bg-gray-400 text-white px-12 py-4 rounded-lg text-lg font-semibold cursor-not-allowed';
            btn.textContent = 'Upload Both Images First';
        }
    </script>
</body>
</html>
